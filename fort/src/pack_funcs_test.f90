program main
    use, intrinsic :: iso_fortran_env, only: wp=>real64
    implicit none
    real(wp) :: test_state(8), test_stm(8,8), test_stt(8,8,8), &
              & test_unpack(8 + 8**2 + 8**3), test_pack(218)
    real(wp) :: output_stm(8,8), output_stt(8,8,8)
    integer i, j, k, c, c2

    call random_number(test_state)
    call random_number(test_stm)
    call random_number(test_stt)

    test_stm(7,:) = 0._wp
    test_stm(8,:) = 0._wp
    test_stm(:,7) = 0._wp
    test_stm(7,7) = 1._wp
    test_stm(8,8) = 1._wp
    test_stm(7,8) = 1._wp

    test_stt(7:,:,:) = 0._wp
    do i=1,6
        test_stt(i,7,:) = 0._wp
        test_stt(i,:,7) = 0._wp
        do j=1,8
            do k=1,j-1
                test_stt(i,k,j) = test_stt(i,j,k)
            end do
        end do
    end do
    test_unpack = [test_state, reshape(test_stm,[8**2]), reshape(test_stt,[8**3])]
    test_pack = packstate(test_unpack)
    output_stm = stm(test_pack)
    output_stt = stt(test_pack)
    print *, "~~~TEST_STM~~~"
    do i=1,8
        print *, real(test_stm(i,:),4)
    end do
    print *, "~~~OUTPUT_STM~~~"
    do i=1,8
        print *, real(output_stm(i,:),4)
    end do
    print *, "~~~DIFF_STM~~~"
    do i=1,8
        print *, real(output_stm(i,:) - test_stm(i,:),4)
    end do
    print *, "~~~TEST_STT~~~"
    do i=1,8
    print *, "i=",i
    do j=1,8
        print *, real(test_stt(i,j,:),4)
    end do
    end do
    print *, "~~~OUTPUT_STT~~~"
    do i=1,8
    print *, "i=",i
    do j=1,8
        print *, real(output_stt(i,j,:),4)
    end do
    end do
    print *, "~~~DIFF_STT~~~"
    do i=1,8
    print *, "i=",i
    do j=1,8
        print *, real(output_stt(i,j,:)-test_stt(i,j,:),4)
    end do
    end do
    print *,maxval(abs(output_stm-test_stm))
    print *,maxval(abs(output_stt-test_stt))

    contains

    pure function stm(x)
        real(wp), intent(in)  :: x(218)
        real(wp)              :: stm(8,8)
        stm=0._wp
        stm(1,1) = x(9)
        stm(1,2) = x(15)
        stm(1,3) = x(21)
        stm(1,4) = x(27)
        stm(1,5) = x(33)
        stm(1,6) = x(39)
        stm(1,8) = x(45)
        stm(2,1) = x(10)
        stm(2,2) = x(16)
        stm(2,3) = x(22)
        stm(2,4) = x(28)
        stm(2,5) = x(34)
        stm(2,6) = x(40)
        stm(2,8) = x(46)
        stm(3,1) = x(11)
        stm(3,2) = x(17)
        stm(3,3) = x(23)
        stm(3,4) = x(29)
        stm(3,5) = x(35)
        stm(3,6) = x(41)
        stm(3,8) = x(47)
        stm(4,1) = x(12)
        stm(4,2) = x(18)
        stm(4,3) = x(24)
        stm(4,4) = x(30)
        stm(4,5) = x(36)
        stm(4,6) = x(42)
        stm(4,8) = x(48)
        stm(5,1) = x(13)
        stm(5,2) = x(19)
        stm(5,3) = x(25)
        stm(5,4) = x(31)
        stm(5,5) = x(37)
        stm(5,6) = x(43)
        stm(5,8) = x(49)
        stm(6,1) = x(14)
        stm(6,2) = x(20)
        stm(6,3) = x(26)
        stm(6,4) = x(32)
        stm(6,5) = x(38)
        stm(6,6) = x(44)
        stm(6,8) = x(50)
        stm(7,7)=1._wp
        stm(7,8)=1._wp
        stm(8,8)=1._wp
    end function stm
    pure function stt(x)
        real(wp), intent(in) :: x(218)
        real(wp)              :: stt(8,8,8)
        stt=0._8
        stt(1,1,1) = x(51)
        stt(1,1,2) = x(57)
        stt(1,1,3) = x(69)
        stt(1,1,4) = x(87)
        stt(1,1,5) = x(111)
        stt(1,1,6) = x(141)
        stt(1,1,8) = x(177)
        stt(1,2,1) = x(57)
        stt(1,2,2) = x(63)
        stt(1,2,3) = x(75)
        stt(1,2,4) = x(93)
        stt(1,2,5) = x(117)
        stt(1,2,6) = x(147)
        stt(1,2,8) = x(183)
        stt(1,3,1) = x(69)
        stt(1,3,2) = x(75)
        stt(1,3,3) = x(81)
        stt(1,3,4) = x(99)
        stt(1,3,5) = x(123)
        stt(1,3,6) = x(153)
        stt(1,3,8) = x(189)
        stt(1,4,1) = x(87)
        stt(1,4,2) = x(93)
        stt(1,4,3) = x(99)
        stt(1,4,4) = x(105)
        stt(1,4,5) = x(129)
        stt(1,4,6) = x(159)
        stt(1,4,8) = x(195)
        stt(1,5,1) = x(111)
        stt(1,5,2) = x(117)
        stt(1,5,3) = x(123)
        stt(1,5,4) = x(129)
        stt(1,5,5) = x(135)
        stt(1,5,6) = x(165)
        stt(1,5,8) = x(201)
        stt(1,6,1) = x(141)
        stt(1,6,2) = x(147)
        stt(1,6,3) = x(153)
        stt(1,6,4) = x(159)
        stt(1,6,5) = x(165)
        stt(1,6,6) = x(171)
        stt(1,6,8) = x(207)
        stt(1,8,1) = x(177)
        stt(1,8,2) = x(183)
        stt(1,8,3) = x(189)
        stt(1,8,4) = x(195)
        stt(1,8,5) = x(201)
        stt(1,8,6) = x(207)
        stt(1,8,8) = x(213)
        stt(2,1,1) = x(52)
        stt(2,1,2) = x(58)
        stt(2,1,3) = x(70)
        stt(2,1,4) = x(88)
        stt(2,1,5) = x(112)
        stt(2,1,6) = x(142)
        stt(2,1,8) = x(178)
        stt(2,2,1) = x(58)
        stt(2,2,2) = x(64)
        stt(2,2,3) = x(76)
        stt(2,2,4) = x(94)
        stt(2,2,5) = x(118)
        stt(2,2,6) = x(148)
        stt(2,2,8) = x(184)
        stt(2,3,1) = x(70)
        stt(2,3,2) = x(76)
        stt(2,3,3) = x(82)
        stt(2,3,4) = x(100)
        stt(2,3,5) = x(124)
        stt(2,3,6) = x(154)
        stt(2,3,8) = x(190)
        stt(2,4,1) = x(88)
        stt(2,4,2) = x(94)
        stt(2,4,3) = x(100)
        stt(2,4,4) = x(106)
        stt(2,4,5) = x(130)
        stt(2,4,6) = x(160)
        stt(2,4,8) = x(196)
        stt(2,5,1) = x(112)
        stt(2,5,2) = x(118)
        stt(2,5,3) = x(124)
        stt(2,5,4) = x(130)
        stt(2,5,5) = x(136)
        stt(2,5,6) = x(166)
        stt(2,5,8) = x(202)
        stt(2,6,1) = x(142)
        stt(2,6,2) = x(148)
        stt(2,6,3) = x(154)
        stt(2,6,4) = x(160)
        stt(2,6,5) = x(166)
        stt(2,6,6) = x(172)
        stt(2,6,8) = x(208)
        stt(2,8,1) = x(178)
        stt(2,8,2) = x(184)
        stt(2,8,3) = x(190)
        stt(2,8,4) = x(196)
        stt(2,8,5) = x(202)
        stt(2,8,6) = x(208)
        stt(2,8,8) = x(214)
        stt(3,1,1) = x(53)
        stt(3,1,2) = x(59)
        stt(3,1,3) = x(71)
        stt(3,1,4) = x(89)
        stt(3,1,5) = x(113)
        stt(3,1,6) = x(143)
        stt(3,1,8) = x(179)
        stt(3,2,1) = x(59)
        stt(3,2,2) = x(65)
        stt(3,2,3) = x(77)
        stt(3,2,4) = x(95)
        stt(3,2,5) = x(119)
        stt(3,2,6) = x(149)
        stt(3,2,8) = x(185)
        stt(3,3,1) = x(71)
        stt(3,3,2) = x(77)
        stt(3,3,3) = x(83)
        stt(3,3,4) = x(101)
        stt(3,3,5) = x(125)
        stt(3,3,6) = x(155)
        stt(3,3,8) = x(191)
        stt(3,4,1) = x(89)
        stt(3,4,2) = x(95)
        stt(3,4,3) = x(101)
        stt(3,4,4) = x(107)
        stt(3,4,5) = x(131)
        stt(3,4,6) = x(161)
        stt(3,4,8) = x(197)
        stt(3,5,1) = x(113)
        stt(3,5,2) = x(119)
        stt(3,5,3) = x(125)
        stt(3,5,4) = x(131)
        stt(3,5,5) = x(137)
        stt(3,5,6) = x(167)
        stt(3,5,8) = x(203)
        stt(3,6,1) = x(143)
        stt(3,6,2) = x(149)
        stt(3,6,3) = x(155)
        stt(3,6,4) = x(161)
        stt(3,6,5) = x(167)
        stt(3,6,6) = x(173)
        stt(3,6,8) = x(209)
        stt(3,8,1) = x(179)
        stt(3,8,2) = x(185)
        stt(3,8,3) = x(191)
        stt(3,8,4) = x(197)
        stt(3,8,5) = x(203)
        stt(3,8,6) = x(209)
        stt(3,8,8) = x(215)
        stt(4,1,1) = x(54)
        stt(4,1,2) = x(60)
        stt(4,1,3) = x(72)
        stt(4,1,4) = x(90)
        stt(4,1,5) = x(114)
        stt(4,1,6) = x(144)
        stt(4,1,8) = x(180)
        stt(4,2,1) = x(60)
        stt(4,2,2) = x(66)
        stt(4,2,3) = x(78)
        stt(4,2,4) = x(96)
        stt(4,2,5) = x(120)
        stt(4,2,6) = x(150)
        stt(4,2,8) = x(186)
        stt(4,3,1) = x(72)
        stt(4,3,2) = x(78)
        stt(4,3,3) = x(84)
        stt(4,3,4) = x(102)
        stt(4,3,5) = x(126)
        stt(4,3,6) = x(156)
        stt(4,3,8) = x(192)
        stt(4,4,1) = x(90)
        stt(4,4,2) = x(96)
        stt(4,4,3) = x(102)
        stt(4,4,4) = x(108)
        stt(4,4,5) = x(132)
        stt(4,4,6) = x(162)
        stt(4,4,8) = x(198)
        stt(4,5,1) = x(114)
        stt(4,5,2) = x(120)
        stt(4,5,3) = x(126)
        stt(4,5,4) = x(132)
        stt(4,5,5) = x(138)
        stt(4,5,6) = x(168)
        stt(4,5,8) = x(204)
        stt(4,6,1) = x(144)
        stt(4,6,2) = x(150)
        stt(4,6,3) = x(156)
        stt(4,6,4) = x(162)
        stt(4,6,5) = x(168)
        stt(4,6,6) = x(174)
        stt(4,6,8) = x(210)
        stt(4,8,1) = x(180)
        stt(4,8,2) = x(186)
        stt(4,8,3) = x(192)
        stt(4,8,4) = x(198)
        stt(4,8,5) = x(204)
        stt(4,8,6) = x(210)
        stt(4,8,8) = x(216)
        stt(5,1,1) = x(55)
        stt(5,1,2) = x(61)
        stt(5,1,3) = x(73)
        stt(5,1,4) = x(91)
        stt(5,1,5) = x(115)
        stt(5,1,6) = x(145)
        stt(5,1,8) = x(181)
        stt(5,2,1) = x(61)
        stt(5,2,2) = x(67)
        stt(5,2,3) = x(79)
        stt(5,2,4) = x(97)
        stt(5,2,5) = x(121)
        stt(5,2,6) = x(151)
        stt(5,2,8) = x(187)
        stt(5,3,1) = x(73)
        stt(5,3,2) = x(79)
        stt(5,3,3) = x(85)
        stt(5,3,4) = x(103)
        stt(5,3,5) = x(127)
        stt(5,3,6) = x(157)
        stt(5,3,8) = x(193)
        stt(5,4,1) = x(91)
        stt(5,4,2) = x(97)
        stt(5,4,3) = x(103)
        stt(5,4,4) = x(109)
        stt(5,4,5) = x(133)
        stt(5,4,6) = x(163)
        stt(5,4,8) = x(199)
        stt(5,5,1) = x(115)
        stt(5,5,2) = x(121)
        stt(5,5,3) = x(127)
        stt(5,5,4) = x(133)
        stt(5,5,5) = x(139)
        stt(5,5,6) = x(169)
        stt(5,5,8) = x(205)
        stt(5,6,1) = x(145)
        stt(5,6,2) = x(151)
        stt(5,6,3) = x(157)
        stt(5,6,4) = x(163)
        stt(5,6,5) = x(169)
        stt(5,6,6) = x(175)
        stt(5,6,8) = x(211)
        stt(5,8,1) = x(181)
        stt(5,8,2) = x(187)
        stt(5,8,3) = x(193)
        stt(5,8,4) = x(199)
        stt(5,8,5) = x(205)
        stt(5,8,6) = x(211)
        stt(5,8,8) = x(217)
        stt(6,1,1) = x(56)
        stt(6,1,2) = x(62)
        stt(6,1,3) = x(74)
        stt(6,1,4) = x(92)
        stt(6,1,5) = x(116)
        stt(6,1,6) = x(146)
        stt(6,1,8) = x(182)
        stt(6,2,1) = x(62)
        stt(6,2,2) = x(68)
        stt(6,2,3) = x(80)
        stt(6,2,4) = x(98)
        stt(6,2,5) = x(122)
        stt(6,2,6) = x(152)
        stt(6,2,8) = x(188)
        stt(6,3,1) = x(74)
        stt(6,3,2) = x(80)
        stt(6,3,3) = x(86)
        stt(6,3,4) = x(104)
        stt(6,3,5) = x(128)
        stt(6,3,6) = x(158)
        stt(6,3,8) = x(194)
        stt(6,4,1) = x(92)
        stt(6,4,2) = x(98)
        stt(6,4,3) = x(104)
        stt(6,4,4) = x(110)
        stt(6,4,5) = x(134)
        stt(6,4,6) = x(164)
        stt(6,4,8) = x(200)
        stt(6,5,1) = x(116)
        stt(6,5,2) = x(122)
        stt(6,5,3) = x(128)
        stt(6,5,4) = x(134)
        stt(6,5,5) = x(140)
        stt(6,5,6) = x(170)
        stt(6,5,8) = x(206)
        stt(6,6,1) = x(146)
        stt(6,6,2) = x(152)
        stt(6,6,3) = x(158)
        stt(6,6,4) = x(164)
        stt(6,6,5) = x(170)
        stt(6,6,6) = x(176)
        stt(6,6,8) = x(212)
        stt(6,8,1) = x(182)
        stt(6,8,2) = x(188)
        stt(6,8,3) = x(194)
        stt(6,8,4) = x(200)
        stt(6,8,5) = x(206)
        stt(6,8,6) = x(212)
        stt(6,8,8) = x(218)
    end function stt
    pure function packstate(x) result(res)
        real(wp), intent(in) :: x(584)
        real(wp)             :: res(218)
        res(:8) = x(:8)
        res(9) = x(9)
        res(10) = x(10)
        res(11) = x(11)
        res(12) = x(12)
        res(13) = x(13)
        res(14) = x(14)
        res(15) = x(17)
        res(16) = x(18)
        res(17) = x(19)
        res(18) = x(20)
        res(19) = x(21)
        res(20) = x(22)
        res(21) = x(25)
        res(22) = x(26)
        res(23) = x(27)
        res(24) = x(28)
        res(25) = x(29)
        res(26) = x(30)
        res(27) = x(33)
        res(28) = x(34)
        res(29) = x(35)
        res(30) = x(36)
        res(31) = x(37)
        res(32) = x(38)
        res(33) = x(41)
        res(34) = x(42)
        res(35) = x(43)
        res(36) = x(44)
        res(37) = x(45)
        res(38) = x(46)
        res(39) = x(49)
        res(40) = x(50)
        res(41) = x(51)
        res(42) = x(52)
        res(43) = x(53)
        res(44) = x(54)
        res(45) = x(65)
        res(46) = x(66)
        res(47) = x(67)
        res(48) = x(68)
        res(49) = x(69)
        res(50) = x(70)
        res(51) = x(73)
        res(52) = x(74)
        res(53) = x(75)
        res(54) = x(76)
        res(55) = x(77)
        res(56) = x(78)
        res(57) = x(137)
        res(58) = x(138)
        res(59) = x(139)
        res(60) = x(140)
        res(61) = x(141)
        res(62) = x(142)
        res(63) = x(145)
        res(64) = x(146)
        res(65) = x(147)
        res(66) = x(148)
        res(67) = x(149)
        res(68) = x(150)
        res(69) = x(201)
        res(70) = x(202)
        res(71) = x(203)
        res(72) = x(204)
        res(73) = x(205)
        res(74) = x(206)
        res(75) = x(209)
        res(76) = x(210)
        res(77) = x(211)
        res(78) = x(212)
        res(79) = x(213)
        res(80) = x(214)
        res(81) = x(217)
        res(82) = x(218)
        res(83) = x(219)
        res(84) = x(220)
        res(85) = x(221)
        res(86) = x(222)
        res(87) = x(265)
        res(88) = x(266)
        res(89) = x(267)
        res(90) = x(268)
        res(91) = x(269)
        res(92) = x(270)
        res(93) = x(273)
        res(94) = x(274)
        res(95) = x(275)
        res(96) = x(276)
        res(97) = x(277)
        res(98) = x(278)
        res(99) = x(281)
        res(100) = x(282)
        res(101) = x(283)
        res(102) = x(284)
        res(103) = x(285)
        res(104) = x(286)
        res(105) = x(289)
        res(106) = x(290)
        res(107) = x(291)
        res(108) = x(292)
        res(109) = x(293)
        res(110) = x(294)
        res(111) = x(329)
        res(112) = x(330)
        res(113) = x(331)
        res(114) = x(332)
        res(115) = x(333)
        res(116) = x(334)
        res(117) = x(337)
        res(118) = x(338)
        res(119) = x(339)
        res(120) = x(340)
        res(121) = x(341)
        res(122) = x(342)
        res(123) = x(345)
        res(124) = x(346)
        res(125) = x(347)
        res(126) = x(348)
        res(127) = x(349)
        res(128) = x(350)
        res(129) = x(353)
        res(130) = x(354)
        res(131) = x(355)
        res(132) = x(356)
        res(133) = x(357)
        res(134) = x(358)
        res(135) = x(361)
        res(136) = x(362)
        res(137) = x(363)
        res(138) = x(364)
        res(139) = x(365)
        res(140) = x(366)
        res(141) = x(393)
        res(142) = x(394)
        res(143) = x(395)
        res(144) = x(396)
        res(145) = x(397)
        res(146) = x(398)
        res(147) = x(401)
        res(148) = x(402)
        res(149) = x(403)
        res(150) = x(404)
        res(151) = x(405)
        res(152) = x(406)
        res(153) = x(409)
        res(154) = x(410)
        res(155) = x(411)
        res(156) = x(412)
        res(157) = x(413)
        res(158) = x(414)
        res(159) = x(417)
        res(160) = x(418)
        res(161) = x(419)
        res(162) = x(420)
        res(163) = x(421)
        res(164) = x(422)
        res(165) = x(425)
        res(166) = x(426)
        res(167) = x(427)
        res(168) = x(428)
        res(169) = x(429)
        res(170) = x(430)
        res(171) = x(433)
        res(172) = x(434)
        res(173) = x(435)
        res(174) = x(436)
        res(175) = x(437)
        res(176) = x(438)
        res(177) = x(521)
        res(178) = x(522)
        res(179) = x(523)
        res(180) = x(524)
        res(181) = x(525)
        res(182) = x(526)
        res(183) = x(529)
        res(184) = x(530)
        res(185) = x(531)
        res(186) = x(532)
        res(187) = x(533)
        res(188) = x(534)
        res(189) = x(537)
        res(190) = x(538)
        res(191) = x(539)
        res(192) = x(540)
        res(193) = x(541)
        res(194) = x(542)
        res(195) = x(545)
        res(196) = x(546)
        res(197) = x(547)
        res(198) = x(548)
        res(199) = x(549)
        res(200) = x(550)
        res(201) = x(553)
        res(202) = x(554)
        res(203) = x(555)
        res(204) = x(556)
        res(205) = x(557)
        res(206) = x(558)
        res(207) = x(561)
        res(208) = x(562)
        res(209) = x(563)
        res(210) = x(564)
        res(211) = x(565)
        res(212) = x(566)
        res(213) = x(577)
        res(214) = x(578)
        res(215) = x(579)
        res(216) = x(580)
        res(217) = x(581)
        res(218) = x(582)
    end function packstate
end program main
